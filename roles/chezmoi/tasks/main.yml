---
# Chezmoi role â€” install chezmoi, deploy age key, run init/apply

- name: Build PATH for chezmoi environment
  ansible.builtin.set_fact:
    chezmoi_path: >-
      {{ target_home }}/.local/bin:{{ target_home }}/.local/share/mise/shims:{{ '/opt/homebrew' if ansible_facts['os_family'] == 'Darwin' and ansible_facts['architecture'] == 'arm64' else '/usr/local' if ansible_facts['os_family'] == 'Darwin' else '/home/linuxbrew/.linuxbrew' }}/bin:/nix/var/nix/profiles/default/bin:{{ ansible_facts['env']['PATH'] }}

- name: Check if chezmoi is already installed
  ansible.builtin.command:
    cmd: which chezmoi
  register: chezmoi_check
  changed_when: false
  failed_when: false

- name: Install chezmoi
  when: chezmoi_check.rc != 0
  block:
    - name: Download chezmoi installer
      ansible.builtin.get_url:
        url: https://get.chezmoi.io
        dest: /tmp/chezmoi-install.sh
        mode: "0755"

    - name: Run chezmoi installer
      become: true
      become_user: "{{ target_user }}"
      ansible.builtin.shell:
        cmd: sh /tmp/chezmoi-install.sh -b "{{ target_home }}/.local/bin"
      args:
        executable: /bin/sh

    - name: Clean up installer
      ansible.builtin.file:
        path: /tmp/chezmoi-install.sh
        state: absent

- name: Create chezmoi config directory
  become: true
  become_user: "{{ target_user }}"
  ansible.builtin.file:
    path: "{{ target_home }}/.config/chezmoi"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_group }}"
    mode: "0700"

- name: Deploy age private key from vault
  become: true
  become_user: "{{ target_user }}"
  ansible.builtin.copy:
    content: "{{ chezmoi_age_key }}"
    dest: "{{ target_home }}/.config/chezmoi/key.txt"
    owner: "{{ target_user }}"
    group: "{{ target_group }}"
    mode: "0600"
  no_log: true

- name: Deploy chezmoi config
  become: true
  become_user: "{{ target_user }}"
  ansible.builtin.template:
    src: chezmoi.toml.j2
    dest: "{{ target_home }}/.config/chezmoi/chezmoi.toml"
    owner: "{{ target_user }}"
    group: "{{ target_group }}"
    mode: "0644"

- name: Check if chezmoi source directory exists
  ansible.builtin.stat:
    path: "{{ target_home }}/.local/share/chezmoi/.chezmoiroot"
  register: chezmoi_source

- name: Check for chezmoi source dir (fallback)
  ansible.builtin.stat:
    path: "{{ target_home }}/.local/share/chezmoi"
  register: chezmoi_source_dir

- name: Initialize chezmoi (first run)
  become: true
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ] && . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      {{ target_home }}/.local/bin/chezmoi init --apply {{ chezmoi_repo }}
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ chezmoi_path }}"
    HOME: "{{ target_home }}"
  when: not chezmoi_source_dir.stat.exists
  register: chezmoi_init

- name: Update chezmoi (subsequent runs)
  become: true
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ] && . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      {{ target_home }}/.local/bin/chezmoi update --force
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ chezmoi_path }}"
    HOME: "{{ target_home }}"
  when: chezmoi_source_dir.stat.exists
  register: chezmoi_update
  changed_when: chezmoi_update.stdout | length > 0
