---
# Homebrew package installation

- name: Set Homebrew paths based on OS
  ansible.builtin.set_fact:
    homebrew_prefix: "{{ '/opt/homebrew' if ansible_facts['os_family'] == 'Darwin' and ansible_facts['architecture'] == 'arm64' else '/usr/local' if ansible_facts['os_family'] == 'Darwin' else '/home/linuxbrew/.linuxbrew' }}"

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/brew"
  register: homebrew_check

- name: Add Homebrew taps
  community.general.homebrew_tap:
    name: "{{ item }}"
    state: present
    path: "{{ homebrew_prefix }}/bin"
  loop: "{{ brew_taps | default([]) }}"
  when:
    - homebrew_check.stat.exists
    - brew_taps | default([]) | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Install Homebrew packages
  community.general.homebrew:
    name: "{{ brew_simple_packages }}"
    state: present
    path: "{{ homebrew_prefix }}/bin"
  when:
    - homebrew_check.stat.exists
    - brew_simple_packages | default([]) | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Install Homebrew packages with custom options
  community.general.homebrew:
    name: "{{ item.name }}"
    state: "{{ item.state | default('present') }}"
    install_options: "{{ item.install_options | default(omit) }}"
    path: "{{ homebrew_prefix }}/bin"
  loop: "{{ brew_custom_packages | default([]) }}"
  when:
    - homebrew_check.stat.exists
    - brew_custom_packages | default([]) | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
